import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import argparse
import os

def main():
    parser = argparse.ArgumentParser(description="Plot Designability Comparison")
    parser.add_argument("csv_file", help="Path to the CSV file generated by compare_designability_per_length.py")
    args = parser.parse_args()

    df = pd.read_csv(args.csv_file)
    
    # Check columns
    required = ['length_bin', 'QFlow_Designability', 'QFlash_Designability']
    for c in required:
        if c not in df.columns:
            print(f"Error: Missing column {c}")
            return
            
    # Parse scRMSD columns
    def parse_scrmsd(val):
        if not isinstance(val, str): return 0.0, 0.0
        try:
            mean_str, std_str = val.split('±')
            return float(mean_str), float(std_str)
        except:
            return 0.0, 0.0

    df['QFlow_scRMSD_mean'], df['QFlow_scRMSD_std'] = zip(*df['QFlow_scRMSD'].map(parse_scrmsd))
    df['QFlash_scRMSD_mean'], df['QFlash_scRMSD_std'] = zip(*df['QFlash_scRMSD'].map(parse_scrmsd))

    # --- Plot 1: Designability ---
    sns.set(style="whitegrid")
    plt.figure(figsize=(10, 6))
    
    sns.lineplot(data=df, x='length_bin', y='QFlow_Designability', marker='o', label='QFlow (Baseline)', linewidth=2.5)
    sns.lineplot(data=df, x='length_bin', y='QFlash_Designability', marker='o', label='QFlash', linewidth=2.5)
    
    plt.title(r'Designability ($\uparrow$)', fontsize=16)
    plt.xlabel('Protein Sequence Length Range', fontsize=12)
    plt.ylabel(r'Designability (Fraction scRMSD < 2Å)', fontsize=12)
    plt.ylim(0.5, 1.05)
    plt.legend(fontsize=12)
    plt.tight_layout()
    
    base = os.path.basename(args.csv_file)
    name, ext = os.path.splitext(base)
    out_path = f"results/{name}_designability_plot.png"
    plt.savefig(out_path, dpi=300)
    print(f"Designability plot saved to {out_path}")
    
    # --- Plot 2: scRMSD ---
    plt.figure(figsize=(10, 6))
    
    # Needs numeric x for fill_between
    x_nums = range(len(df))
    
    # QFlow
    plt.plot(x_nums, df['QFlow_scRMSD_mean'], marker='o', label='QFlow (Baseline)', linewidth=2.5)
    plt.fill_between(x_nums, 
                     df['QFlow_scRMSD_mean'] - df['QFlow_scRMSD_std'], 
                     df['QFlow_scRMSD_mean'] + df['QFlow_scRMSD_std'], 
                     alpha=0.2)
                     
    # QFlash
    plt.plot(x_nums, df['QFlash_scRMSD_mean'], marker='o', label='QFlash', linewidth=2.5)
    plt.fill_between(x_nums, 
                     df['QFlash_scRMSD_mean'] - df['QFlash_scRMSD_std'], 
                     df['QFlash_scRMSD_mean'] + df['QFlash_scRMSD_std'], 
                     alpha=0.2)

    plt.xticks(x_nums, df['length_bin'])
    plt.title(r'scRMSD ($\downarrow$)', fontsize=16)
    plt.xlabel('Protein Sequence Length Range', fontsize=12)
    plt.ylabel(r'scRMSD (Å)', fontsize=12)
    plt.legend(fontsize=12)
    plt.tight_layout()
    
    out_path_rmsd = f"results/{name}_scrmsd_plot.png"
    plt.savefig(out_path_rmsd, dpi=300)
    print(f"scRMSD plot saved to {out_path_rmsd}")

if __name__ == "__main__":
    main()
